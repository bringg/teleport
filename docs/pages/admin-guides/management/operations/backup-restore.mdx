---
title: Backup and Restore
description: How to back up and restore your Teleport cluster state.
---
This guide explains the components of your Teleport deployment that must be
backed up and lays out our recommended approach for performing backups.

(!docs/pages/includes/cloud/call-to-action.mdx!)

## Teleport service state

While the Teleport Proxy Service and Agent services are stateless, you should
ensure that you can restore their configuration files (`/etc/teleport.yaml` by
default).

Teleport Enterprise (Cloud) manages all Auth Service backups. If you self-host
your Teleport cluster, you must back up the Teleport Auth Service yourself.

The Auth Service is Teleport's brain, and depending on the backend should be
backed up regularly.

For example, a Teleport cluster running on AWS with DynamoDB must back up the
following data:

| What | Where ( Example AWS Customer ) |
| - | - |
| Local Users ( not SSO ) | DynamoDB |
| Certificate Authorities | DynamoDB |
| Trusted Clusters | DynamoDB |
| Connectors: SSO | DynamoDB / File System |
| RBAC | DynamoDB / File System |
| teleport.yaml | File System |
| teleport.service | File System |
| license.pem | File System |
| TLS key/certificate | File System / AWS Certificate Manager |
| Audit log | DynamoDB |
| Session recordings | S3 |

For this customer, we would recommend using [AWS best practices](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/BackupRestore.html) for backing up DynamoDB. If DynamoDB is used for
Teleport audit logs, logged events have a TTL of 1 year.

| Backend | Recommended backup strategy |
| - | - |
| Local Filesystem | Back up the data directory (`/var/lib/teleport/` by default) |
| DynamoDB | [Follow AWS's guidelines for backup and restore](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/BackupRestore.html) |
| etcd | [Follow etcd's guidelines for disaster recovery](https://etcd.io/docs/v2/admin_guide) |
| Firestore | [Follow GCP's guidelines for automated backups](https://firebase.google.com/docs/database/backups) |

## Dynamic resources

Teleport uses [dynamic
resources](../../infrastructure-as-code/infrastructure-as-code.mdx) for roles,
local users, authentication connectors, and other configurations. We recommend
that you back up your configuration resources because they are essential to the
normal operation of your cluster.

### Using infrastructure as code (recommended)

We recommend managing dynamic resources as code using one of the following
tools, along with a version control system and continuous deployment pipeline
that applies your configurations automatically:

- [Teleport Terraform
  provider](../../infrastructure-as-code/terraform-provider/terraform-provider.mdx)
- [Teleport Kubernetes
  operator](../../infrastructure-as-code/teleport-operator/teleport-operator.mdx)

This way, you can ensure that all Teleport configurations in your cluster are
always up to date. Your source repository can act as a backup of your dynamic
configurations, and restoring is only a matter of applying these configurations.

### Using manual commands

To retrieve a dynamic resource with `tctl`, run the following command:

```code
$ tctl get <RESOURCE_KIND>
```

For example, the following command retrieves all roles created on your cluster:

```code
$ tctl get role
```

To back up a resource definition, you can use `tctl get` along with shell
redirection, for example:

```code
$ tctl get role > myrole.yaml
```

You can restore a dynamic resource against a new cluster (or a cluster with a
new backend) by running the following command, replacing `myrole.yaml` with the
name of the file where you wrote the resource manifest:

```code
$ tctl create myrole.yaml
```

The following list includes all available Teleport resource kinds:

<Details title="Available resource kinds">
(!docs/pages/includes/resource_kinds.mdx!)
</Details>

To retrieve resources of a given kind, and recreate them when needed, at least
one of your user's Teleport roles must include permissions similar to the
following:

```yaml
allow:
  - resources: [session]
    verbs: [list, create]
```

In this case, `session` is the resource kind.

### On an Auth Service instance

If you self-host Teleport and have access to the machine that runs the Teleport
Auth Service, you can run a command to retrieve all resource manifests and print
them to a single file, then restart the Teleport Auth Service:

1. Log in to your Auth Service machine and run the following command:

   ```code
   $ tctl get all --with-secrets > state.yaml
   ```

1. Prepare a new uninitialized backend (make sure to port any non-default config
   values from the old config file):

   ```code
   $ mkdir fresh && cat > fresh.yaml << EOF
   teleport:
     data_dir: fresh
   EOF
   ```

1. Stop Teleport on the Auth Service instance.

1. Restart Teleport on the Auth Service instance with the fresh backend and the
   state file you created earlier:

   ```code
   $ sudo teleport start --config fresh.yaml --bootstrap state.yaml
   ```

1. From another terminal, verify that the state transferred correctly:

   ```code
   $ tctl --config fresh.yaml get all
   # <your state here>
   ```

The `--bootstrap` flag has no effect, except when the Auth Service initializes
its backend on first startup, so it is safe for use in supervised/High
Availability contexts.

The `--bootstrap` flag doesn't re-trigger Trusted Cluster handshakes, so Trusted
Cluster resources need to be recreated manually.

All the same limitations around modifying the config file of an existing cluster
also apply to a new cluster being bootstrapped from the state of an old cluster:

  - Changing the cluster name will break your CAs. This will be caught and Teleport
    will refuse to start.
  - Some user authentication mechanisms (e.g. WebAuthn) require that the public
    endpoint of the Web UI remains the same. This cannot be caught by Teleport,
    so be careful!
  - Any Teleport Agent whose invite token is defined in the Auth Service's
    configuration file will be able to join automatically, but Agents that were
    added dynamically will need to be re-invited.

